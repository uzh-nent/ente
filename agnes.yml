agnes:
  version: 4

build:
  path: .build

github:
  api_token: '%env(GITHUB_API_TOKEN)%'
  repository: uzh-nent/ente

config:
  path: .agnes
  # repository:
  #  url: git@gitlab.uzh.ch:nent/ente-config

data:
  shared_folders:
    - var/persistent

  files:
    - path: .env.local
      required: true
    - path: .cert/elm-sslcertificate.fullchain.pem
      required: false
    - path: .cert/elm-sslkey.key
      required: false

scripts:
  build:
    hook: build
    script:
      - composer install --verbose --prefer-dist --no-interaction --no-dev --optimize-autoloader --no-scripts
      - npm install
      - npm run build
      - rm -rf node_modules

  deploy:
    hook: deploy
    script:
      - php bin/console cache:warmup -n
      - php bin/console doctrine:migrations:migrate -n
      - sudo chown -R www-data:www-data .
      - sudo chmod 0640 .env.local
      - sudo chmod 0640 .cert/*

  rollback:
    hook: rollback
    script:
      - cd $PREVIOUS_RELEASE_PATH && export MIGRATE_TO=$(php bin/console doctrine:migrations:latest)
      - php bin/console doctrine:migrations:migrate $MIGRATE_TO -n
